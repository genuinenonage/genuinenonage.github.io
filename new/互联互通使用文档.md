# 互联互通使用文档  
## 什么是互联互通  
* 是两个（或更多）运营商之间的连接（网间互联）。  
* 随着电信技术的发展以及政府规制政策的转变，如有新的运营商进入电信市场。对于新运营商来说，网间互联简直就是生命之源。  
* 如果没有与主导运营商的网络互联，业务难以得到充分开展，网络成本也就无法回收。而要投巨资建设一个与原垄断运营商相抗衡的电信网一般来说也是不现实的。  
* **而用友的互联互通项目，是指的不同格式的电子病历，能通过互联互通获得相同格式的电子病历。**  
## 环境安装流程  
1. 下载并安装jdk8并配置环境  
2. 下载并安装eslipse并配置为本地jdk8  
3. 下载并安装maven
	1. 配置本地仓库  
	2. 配置阿里云私库或用友的（部分jar包只有用友私库存在）  
	
4. 下载并安装SVN  
	1. 安装完需要重启
	2. 拉取代码（需要账户），网址：http://rd-code-hit.yonyou.com//svn/HIP/HIP-HLHT/branches/gxmz  ，拉取完代码后，将下面五个模块导入到eslipse中，在web模块中PathToDocumentController.java启动后台服务。
		* file-service  
		* HISClient-service  
		* hlht-core  
		* hlht-framework  
		* hlht-web  

5. 下载并安装node.js并配置环境  
	1. 换淘宝的：npm install --registry=https://registry.npm.taobao.org  

6. 下载并安装webstorm或vscode  
	1. 在webstorm中导入 **hlht-view** 一个模块  
	2. View模块的config-index.js 中修改后台接口的端口号：127.0.0.1:8090
	3. 使用npm运行dev，前端启动
	4. 使用edge浏览器打开，ie和谷歌浏览器打开会有问题。
	5. 登录账号：1；密码123。  


## Oracle常用的表  
1. 数据管理  
	1. DE_BASE_SET 数据集
	2. DE_RECORD 数据子集
	3. DE_DATA_ELEMENT 数据元
	4. DE_DATA_MATCH 业务值域对应表
	5. DE_R_RECORD_ELEMENT 数据子集关系表
	6. DE_DICT 标准字典(代码表)
	7. DE_DICT_DT 标准字典（代码值列表）
	8. DE_DOMAIN 数据元值域
	9. DE_R_RECORD_ELEMENT 数据元内部标识符
	10. DE_RECORD 数据子集关系表
	11. DE_WS_OID  OID管理 类别名称(维护对象标识符)
	12. DE_WS_OID_DT OID管理 类别明细
2. ENTITY_XMLNODE 实体xml节点  
3. LEAVE_HOSPITAL 出院信息表
4. 院外服务
	1. MEDICAL_DEPARTMENT 医疗卫生机构
	2. MEDICAL_PERSONNEL 医疗卫生人员
	3. PATIENT_REGISTER 个人信息注册表（患者）

5. SH
	1. SH_DOC_STRUCTURE 文档结构管理
	2. SH_DOC_TEMPLATE 模板管理
	3. SH_INTERACT_COMPARE
	4. SH_INTERACT_DOC
	5. SH_INTERACT_TEMPLATE
	6. SH_MISS
	7. SH_MISS_OPS
	8. SH_SQL_DATA
	9. SH_XML_COMPARE
	10. SH_XML_COMPARE2

6. 系统与用户
	1. SYS_CD_DICT
	2. SYS_CONFIG 系统参数表
	3. SYS_DEPT 部门表
	4. SYS_LOGIN_LOG 登录日志表
	5. SYS_ORG 机构表
	6. SYS_R_ROLE_RESOURCE 角色资源关联表
	7. SYS_R_USER_DEPT 人员部门关联表
	8. SYS_R_USER_ROLE 人员角色关联表
	9. SYS_RESOURE 资源表
	10. SYS_ROLE 角色表
	11. SYS_USER 资源表

## 页面功能  
1. 用户管理：管理机构、部门、人员、角色、资源
2. 系统管理：
	1. 管理系统参数。
	2. 业务配置：决定开始/停止 同步数据
	3. 远程调用：选择CDA文档 和 患者主索引 开始远程调用。

3. 标准数据管理：管理字典、OID、数据集、数据元。
4. CDA文档管理：
	1. 文档模板管理：
		1. 模板管理。
		2. 内容管理：根据文档版本与模板类型 筛选查看文档。
		3. XML文档映射和对比：国家标准XML与业务XML相互之间映射。最终发送新增。

	2. 文档结构管理：管理文档模板，文档、章节、条目、元素、子元素（与构建好的）。
	3. 文档标准化：
		1. 原始文档查看：原始文件批量上传。和通过转化好的文件的id查找原始文件。
		2. CDA文档库：转化出现错误/文件丢失等错误，重新生成文件。
		3. 患者病历记录：患者的病历记录。
		4. 患者病历集：记录患者详细病历文档。

	4. 数据统计：无用。

5. 交互服务：院内与院外 机构之间的互联互通。
	1. 院内服务。
	2. 院外服务。
	3. 交互服务映射和对比：与XML文档映射和对比类似
	4. 交互服务模板管理：管理交互模板

## 后端模块
1. hlht-web：主要业务模块，先调用这个模块的控制类。
	* 启动：hlht-web ，扫描@ComponentScan(“com.you.health”) 5个模块所有的Java文件。

2. hlht-framework：登录，用户管理，系统管理，系统应用的业务操作模块（字典，部门，组织，资源，角色，用户，配置，登录等）
3. hlht-core：业务增删改数据的模块 非常多entry实体类；dao持久层
4. hisclient-service：互联互通数据源处理，sql在文件夹对应xml中。
5. file-service：处理模板与文档，使用mongodb数据库。在dev配置文件中配置。

## 主要业务

### 用户管理-机构管理  
	1. 点击新增，输入信息，确定  
	/hlht-framework/---/health/restController/SysOrgController.java  

### 业务配置
	1. 门急诊病历选择开始
	2. HIS同步到互联互通的数据入mongodb接口
	/hlht-web/---/health/hlht/restController/HisDataController.java/getDatafromHis  

	/hlht-web/---/health/hlht/utils/ResourceUtils.java/setProperty 设置配置文件的值  
  
	/hlht-web/---/health/hlht/service/cmn/impl/GetDatafromHis.java/runTask/stoptask    

	runTask() 开启任务获取his的数据并存到MongoDB中  
	handleMissData(fileDateStr) 远程调用His--急门诊病历数据
	3. 选择关闭，调用相同的方法，停止同步。

### CDA文档管理  
##### 模板管理  
	1. 点击新增模板。会打开新建框
	2. 选择已创建好的文档名称，会自动赋值文档编码。
	3. 输入文档模板id，模板版本，选择模板类型，导入模板文件。
	4. 点击确定，保存。   
	5. 保存到mongodb数据库上  
	/file-service/---/health/file/controller/TemplateController.java/upload
	
	6. 将文档模板信息保存到Oracle数据库上，添加到文档模板列表上。  
	/hlht-web/---/health/hlht/restController/ShDocTemplateController.java/addDocTemplate  

	7. 返回成功信息。

##### 文档维护  
	1. 点击新增文档，输入信息，确定  
	/hlht-web/src/main/java/com/yonyou/health/hlht/restController/ShDocStructureController.java  
	
### 交互服务
##### 交互服务模板管理
	/hlht-web/---/health/hlht/restController/ShDocTemplateController.java  

##### 院内服务-医护人员管理   
	1. 点击注册，输入信息，点击确定    
	2. 后端WebService处理  
	/hlht-web/---/health/hlht/server/courtController/CourtServerController.java

## 难点  
* 院内院外服务未启动，file-service未启动。  
* 无法使用交互服务和核心功能XML文档映射，及自动电子病历转换。  

## 全流程 
	1. 用户管理: 构建机构-部门-角色-人员-资源
	2. 系统管理: 构建系统参数 || 是否启动业务服务 
	3. 标准数据管理: 构建字典代码表-创建字典代码值列表-构建OID 类别-构建OID类别明细(OID描述为字典代码表字典名称)  ||  构建数据集-构建数据子集-构建数据元-关联子集与数据元关系表-构建数据元值域列表-数据元值域管理-构建业务值域对应(需要数据元,标准值域为数据元值域).
	4. CDA(数据)文档管理: 
		1. 文档模板管理: 构建文档模板(相同文档名称的国家标准与业务对应，都需要模板文件)-在内容管理中查看-在xml文档映射和对比中：国家映射业务-为源数据指向数据元-xml文档体映射 发送
		2. 文档结构管理: 构建文档-章节-条目-元素-子元素（初始已拥有，需在表创建）  

	5. 交互服务: 构建交互服务模板-交互服务映射-新增成功.

